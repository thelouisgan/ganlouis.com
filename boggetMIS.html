<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Registration System</title>
    <style>
        :root {
            --my-brand-font: 'Open Sans';
            --my-headline-font: 'Montserrat';
            --my-title-font: 'Montserrat';
            --my-plain-font: 'Space Grotesk', sans-serif;

            --md-ref-typeface-brand: var(--my-brand-font);
            --md-ref-typeface-plain: var(--my-plain-font);

            --md-sys-typescale-headline-font: var(--my-headline-font);
            --md-sys-typescale-title-font: var(--my-title-font);
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            margin: 0;
            padding: 0;
            font-size: 1.2rem;
        }

        .container {
            max-width: 1920px;
            margin: auto;
            padding: 20px;
            margin-top: 50px;
        }
        md-filter-chip {
            --md-filter-chip-label-text-size: 1rem;
            --md-filter-chip-container-height: 40px;
            padding: 0 2px;
            margin: 0 8px;
        }

        .chips {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 13px;
        }
        
        p {
            font-family: var(--my-plain-font);
            font-size: var(--my-plain-font-size);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        #peopleList {
            display: grid;
            grid-template-columns: repeat(var(--columns), 1fr);
            gap: 20px;
        }

        .name-button-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .name {
            font-weight: 500;
            margin-right: 10px;
        }

        .alert-button {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .card-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .last-seen {
            color: #666;
            font-size: 0.9rem;
        }

        .card {
            background-color: rgb(255, 255, 255);
            border-radius: 8px;
            border: 1px solid #000000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition-duration: 300ms;
            transition-property: transform, box-shadow;
            transition-timing-function: ease-out;
            transform: rotate3d(0);
            position: relative; /* Needed for absolute positioning of glow */
        }

        .card:hover {
            transition-duration: 150ms;
            box-shadow: 0 5px 20px 5px #00000044;
        }

        .card .glow {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            pointer-events: none; /* Allow interactions with elements below */
            background: transparent; /* Start with transparent background */
            mix-blend-mode: screen; /* This will make the glow blend with content beneath */
        }

        .card:hover .name,
        .card:hover .last-seen {
            font-weight: 700;
            transition: font-weight 0.2s ease;
        }

        .card.selected {
            background-color: transparent;
        }

        .img-container {
            height: var(--img-height);
            width: 90%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 15px
        }
        .img-container img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        .alert-button {
            color: white;
            border: 1px solid #000000;
            font-family: var(--my-plain-font);
            color: black;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .alert-button:hover {
            background-color: #ff0000;
            color: white;
            font-weight: 700;
            transition: background-color 0.2s ease;
            transition: font-weight 0.2s ease;
        }
        .alert-button:active {
            background-color: #7d0000;
        }

        @keyframes breathe {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
            }
            100% {
                box-shadow: 0 0 0 10px rgba(255, 0, 0, 0);
            }
        }

        .alert-banner {
            display: none;
            position: fixed;
            top: -50px; /* Start hidden above the view */
            left: 0;
            width: 100%;
            background-color: red;
            color: white;
            text-align: center;
            padding: 10px 0;
            transition: top 0.5s ease-in-out;
            z-index: 1000; /* Ensure it's above other content */
        }

        .alert-banner.show {
            top: 0; /* Dropdown position */
        }

        .card.alerted {
            animation: breathe 2s infinite;
        }

        .card.alerted .alert-button {
            background-color: #ff0000;
            color: white;
        }

        .ticker-wrap {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            padding: 10px 0;
            overflow: hidden;
            z-index: 1000;
            border-bottom: #000000 1px solid;
        }

        .ticker {
            display: flex;
            white-space: nowrap;
            animation: ticker 20s linear infinite;
        }

        .ticker-item {
            display: inline-block;
            border: 1px solid #000000;
            margin: 0 5px;
            border-radius: 4px;
            padding: 0 5px;
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: font-weight 0.2s ease;
            will-change: transform; /* Optimize for animations */
        }

        .ticker-item:hover {
            font-weight: 700;
            /* Keep the transition consistent to avoid flickering */
        }

        .ticker-item.alert {
            background-color: #ff0000;
            color: #ffffff;
            font-weight: bold;
        }

        @keyframes ticker {
            0% {
                transform: translate3d(0, 0, 0);
            }
            100% {
                transform: translate3d(-100%, 0, 0);
            }
        }

        .ticker-item:hover {
            animation-play-state: paused;
        }

        md-filter-chip {
            margin: 0 4px;
        }
        md-list {
            --md-list-container-color: none;
        }
    </style>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">

    <script type="importmap">
        {
            "imports": {
                "@material/web/": "https://esm.run/@material/web/"
            }
        }
    </script>
    <script type="module">
        import '@material/web/all.js';
        import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';
        document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
        import '@material/web/chips/filter-chip.js';
        import '@material/web/chips/chip-set.js';
    </script>
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>


    <div class="ticker-wrap">
        <div class="ticker" id="ticker">
            <div class="ticker-item"></div>
            <div class="ticker-item"></div>
            <div class="ticker-item"></div>
            <div class="ticker-item"></div>
            <div class="ticker-item"></div>
            <div class="ticker-item"></div>
            <div class="ticker-item"></div>
            <div class="ticker-item"></div>
            <div class="ticker-item"></div>
            <div class="ticker-item"></div>
        </div>
    </div>

    <div id="alertBanner" class="alert-banner">Registration alert sent</div>
    <div class="container">
        <div class="chips">
            <md-chip-set>
                <md-filter-chip label="Louis" data-category="L"></md-filter-chip>
                <md-filter-chip label="Candace" data-category="C"></md-filter-chip>
            </md-chip-set>
        </div>
        <md-list id="peopleList">
            <!-- List items will be loaded here dynamically -->
        </md-list>
    </div>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDRsP7g5tzwFSK-gu6IN2DhCYUKGZqxN2A",
            authDomain: "ganlouisdotcom.firebaseapp.com",
            databaseURL: "https://ganlouisdotcom-default-rtdb.firebaseio.com",
            projectId: "ganlouisdotcom",
            storageBucket: "ganlouisdotcom.appspot.com",
            messagingSenderId: "26247490244",
            appId: "1:26247490244:web:4067a84728289e33f9f791",
            measurementId: "G-RM3WTFFF64"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const people = [
            { name: "Amber", category: "C" }, { name: "Anastasia", category: "C" }, { name: "Ariel", category: "L" },
            { name: "Axolotl", category: "C" }, { name: "Baymax", category: "L" }, { name: "Beary", category: "C" },
            { name: "Bogget", category: "L" }, { name: "Bwaly", category: "C" }, { name: "Bwally", category: "C" },
            { name: "Captain Barnacles", category: "C" }, { name: "Catty", category: "L" }, { name: "Chacha", category: "L" },
            { name: "Cowger", category: "L" }, { name: "Crocodile", category: "C" }, { name: "Doc", category: "C" },
            { name: "Ducky", category: "C" }, { name: "Duckies", category: "C" }, { name: "Doggy", category: "L" },
            { name: "Elsa", category: "C" }, { name: "Flamingo", category: "C" }, { name: "Froggy", category: "L" },
            { name: "George", category: "C" }, { name: "Hello Kitty", category: "C" }, { name: "Hylo", category: "C" },
            { name: "Koaly", category: "C" }, { name: "Lily", category: "C" }, { name: "Liony", category: "C" },
            { name: "Lula", category: "C" }, { name: "Miss Pom Pom", category: "C" }, { name: "Paddington", category: "L" },
            { name: "Pandy", category: "C" }, { name: "Parrot", category: "C" }, { name: "Peggy", category: "C" },
            { name: "Pikachu", category: "C" }, { name: "PPG", category: "C" }, { name: "Rabbit", category: "C" },
            { name: "Rainbow Dash", category: "C" }, { name: "Rapunzel", category: "C" }, { name: "Ri", category: "L" },
            { name: "Rikete", category: "L" }, { name: "Rocket", category: "C" }, { name: "Scratchy", category: "C" },
            { name: "Snowy", category: "L" }, { name: "Spiderman", category: "C" }, { name: "Tallula", category: "C" },
            { name: "Tapir", category: "C" }, { name: "Uny", category: "C" }, { name: "Winnie the Pooh", category: "C" },
            { name: "Yoshi", category: "C" }, { name: "Zebra", category: "L" }
        ];

        function formatTimestamp(timestamp) {
            const now = new Date();
            const date = new Date(timestamp * 1000);
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            const options = { hour: 'numeric', minute: 'numeric', hour12: true };

            if (isNaN(date.getTime())) return "never seen";
            if (seconds < 1) return "last seen just now";
            if (seconds < 60) return "last seen " + seconds + " second" + (seconds > 1 ? "s" : "") + " ago";
            if (hours < 1) return "last seen " + minutes + " minute" + (minutes > 1 ? "s" : "") + " ago";
            if (hours < 24) return "last seen " + hours + " hour" + (hours > 1 ? "s" : "") + " ago";
            if (days < 2) return `last seen yesterday at ${date.toLocaleTimeString(undefined, options)}`;
            if (days < 7) return `last seen ${days} day${days > 1 ? "s" : ""} ago at ${date.toLocaleTimeString(undefined, options)}`;

            const dateOptions = { month: 'short', day: 'numeric' };
            return `${date.toLocaleDateString(undefined, dateOptions)} at ${date.toLocaleTimeString(undefined, options)}`;
        }

        function updateTimestamp(name) {
            const timestamp = Math.floor(Date.now() / 1000); // Unix timestamp in seconds
            firebase.database().ref('boggetMIS/' + name).set({
                lastSeen: timestamp
            }).then(() => {
                console.log(name + ' last seen updated to ' + timestamp);
                document.getElementById('lastSeen' + name).innerText = formatTimestamp(timestamp);
            }).catch((error) => {
                console.error('Error updating last seen for ' + name, error);
            });
        }

        function loadLastSeen() {
            people.forEach(person => {
                firebase.database().ref('boggetMIS/' + person.name).get().then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const lastSeenTimestamp = data.lastSeen;
                        document.getElementById('lastSeen' + person.name).innerText = formatTimestamp(lastSeenTimestamp);
                    } else {
                        document.getElementById('lastSeen' + person.name).innerText = "Never seen";
                    }
                }).catch((error) => {
                    console.error('Error loading last seen for ' + person.name, error);
                });
            });
        }

        function createListItems() {
            const listContainer = document.getElementById('peopleList');
            people.forEach(person => {
                const card = document.createElement('div');
                card.className = 'card';
                card.id = person.name;
                card.dataset.category = person.category;
                card.onclick = () => {
                    card.classList.toggle('selected');
                    updateTimestamp(person.name);
                };

                // Add glow element
                const glow = document.createElement('div');
                glow.className = 'glow';
                card.appendChild(glow);

                const imgContainer = document.createElement('div');
                imgContainer.className = 'img-container';

                const img = document.createElement('img');
                img.src = `https://ganlouis.com/wp-content/uploads/2024/06/${person.name.replace(/\s+/g, '-')}.png`;
                img.alt = `${person.name}'s avatar`;

                imgContainer.appendChild(img);

                const cardContent = document.createElement('div');
                cardContent.className = 'card-content';

                const nameButtonContainer = document.createElement('div');
                nameButtonContainer.className = 'name-button-container';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'name';
                nameDiv.innerText = person.name;

                const alertButton = document.createElement('button');
                alertButton.className = 'alert-button';
                alertButton.textContent = 'ALERT';
                alertButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleAlert(person.name, card, alertButton);
                });

                nameButtonContainer.appendChild(nameDiv);
                nameButtonContainer.appendChild(alertButton);

                const lastSeenDiv = document.createElement('div');
                lastSeenDiv.className = 'last-seen';
                lastSeenDiv.id = 'lastSeen' + person.name;

                cardContent.appendChild(nameButtonContainer);
                cardContent.appendChild(lastSeenDiv);

                card.appendChild(imgContainer);
                card.appendChild(cardContent);

                listContainer.appendChild(card);

                card.addEventListener('mouseenter', () => {
                    const bounds = card.getBoundingClientRect();
                    const rotateFunc = (e) => rotateToMouse(e, card, bounds);
                    card.addEventListener('mousemove', rotateFunc);
                    card.addEventListener('mouseleave', () => {
                        card.removeEventListener('mousemove', rotateFunc);
                        card.style.transform = '';
                        card.querySelector('.glow').style.backgroundImage = '';
                    });
                });
            });
        }

        function rotateToMouse(e, card, bounds) {
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            const leftX = mouseX - bounds.x;
            const topY = mouseY - bounds.y;
            const center = {
                x: leftX - bounds.width / 2,
                y: topY - bounds.height / 2
            }
            
            const maxRotation = 5; // Maximum rotation in degrees
            const maxTilt = 30; // Maximum tilt for the glow effect

            const percentageX = (leftX / bounds.width - 0.5) * 2; // -1 to 1
            const percentageY = (topY / bounds.height - 0.5) * 2; // -1 to 1

            const rotateX = percentageY * maxRotation;
            const rotateY = -percentageX * maxRotation;

            card.style.transform = `
                perspective(1000px)
                rotateX(${rotateX}deg)
                rotateY(${rotateY}deg)
                scale3d(1.03, 1.03, 1.03)
            `;

            const glowX = 50 + percentageX * maxTilt;
            const glowY = 50 + percentageY * maxTilt;

            const glowElement = card.querySelector('.glow');
            glowElement.style.background = `
                radial-gradient(
                    circle at ${glowX}% ${glowY}%,
                    rgba(255, 255, 255, 0.3),
                    rgba(255, 255, 255, 0) 50%
                )
            `;
        }

        function toggleAlert(name, card, button) {
            const alertRef = firebase.database().ref(`boggetMIS/${name}/alertstats`);
            alertRef.get().then((snapshot) => {
                const currentState = snapshot.val() || false;
                const newState = !currentState;
                alertRef.set(newState).then(() => {
                    updateAlertUI(card, button, newState);
                }).catch((error) => {
                    console.error('Error updating alert state:', error);
                });
            }).catch((error) => {
                console.error('Error reading alert state:', error);
            });
        }

        function updateAlertUI(card, button, isAlerted) {
            if (isAlerted) {
                card.classList.add('alerted');
                button.textContent = 'OFF';
            } else {
                card.classList.remove('alerted');
                button.textContent = 'ALERT';
            }
        }

        function loadAlertStates() {
            people.forEach(person => {
                const alertRef = firebase.database().ref(`boggetMIS/${person.name}/alertstats`);
                alertRef.get().then((snapshot) => {
                    const isAlerted = snapshot.val() || false;
                    const card = document.getElementById(person.name);
                    const button = card.querySelector('.alert-button');
                    updateAlertUI(card, button, isAlerted);
                }).catch((error) => {
                    console.error('Error loading alert state for ' + person.name, error);
                });
            });
        }

        function updateTicker() {
            const tickerContainer = document.getElementById('ticker');
            tickerContainer.innerHTML = ''; // Clear existing items
            const recentUpdates = [];
            const alertedItems = [];

            people.forEach(person => {
                firebase.database().ref('boggetMIS/' + person.name).get().then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const lastSeenTimestamp = data.lastSeen;
                        const isAlerted = data.alertstats || false;
                        
                        if (isAlerted) {
                            alertedItems.push({
                                name: person.name,
                                lastSeen: lastSeenTimestamp
                            });
                        } else {
                            recentUpdates.push({
                                name: person.name,
                                lastSeen: lastSeenTimestamp
                            });
                        }

                        if (recentUpdates.length + alertedItems.length === people.length) {
                            // Sort updates by most recent
                            recentUpdates.sort((a, b) => b.lastSeen - a.lastSeen);
                            alertedItems.sort((a, b) => b.lastSeen - a.lastSeen);

                            // Combine alerted items and recent updates
                            const combinedUpdates = [...alertedItems, ...recentUpdates];

                            // Create and append ticker items
                            combinedUpdates.forEach((update) => {
                                const tickerItem = document.createElement('div');
                                tickerItem.className = 'ticker-item';
                                if (alertedItems.includes(update)) {
                                    tickerItem.classList.add('alert');
                                    tickerItem.textContent = `ALERT | ${update.name} was ${formatTimestamp(update.lastSeen)}`;
                                } else {
                                    tickerItem.textContent = `${update.name} was ${formatTimestamp(update.lastSeen)}`;
                                }
                                tickerContainer.appendChild(tickerItem);
                            });
                        }
                    }
                }).catch((error) => {
                    console.error('Error loading data for ' + person.name, error);
                });
            });
        }

        function adjustLayout() {
            const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
            const imgHeightRatio = 0.15; // 15% of viewport height
            const imgHeight = vh * imgHeightRatio;
            const columns = window.innerWidth >= 1200 ? 4 : (window.innerWidth >= 768 ? 3 : (window.innerWidth >= 500 ? 2 : 1));

            document.documentElement.style.setProperty('--img-height', `${imgHeight}px`);
            document.documentElement.style.setProperty('--columns', columns);
        }

        function updateFilter() {
            const selectedCategories = Array.from(document.querySelectorAll('md-filter-chip'))
                .filter(chip => chip.classList.contains('selected')) // Check for 'selected' class
                .map(chip => chip.dataset.category);

            document.querySelectorAll('.card').forEach(card => {
                card.style.display = selectedCategories.length === 0 || selectedCategories.includes(card.dataset.category)
                    ? 'block'
                    : 'none';
            });
        }

        document.querySelectorAll('.ticker-item').forEach(item => {
            item.addEventListener('mouseenter', () => {
                const ticker = document.querySelector('.ticker');
                ticker.style.animationPlayState = 'paused';
            });

            item.addEventListener('mouseleave', () => {
                const ticker = document.querySelector('.ticker');
                ticker.style.animationPlayState = 'running';
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            updateTicker();
            createListItems();
            loadLastSeen();
            adjustLayout();
            loadAlertStates();
            
            window.addEventListener('resize', adjustLayout);

            const filterChips = document.querySelectorAll('md-filter-chip');
            filterChips.forEach(chip => {
                chip.addEventListener('click', () => {
                    chip.classList.toggle('selected'); // Use class to indicate selection
                    updateFilter();
                });
            });

            // Initial filter update
            updateFilter();

            // Font loading
            const fontLoader = new FontFace('Space Grotesk', 'url(https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap)', {
                weight: '300 700',
                style: 'normal'
            });

            fontLoader.load().then((font) => {
                document.fonts.add(font);
            }).catch((error) => {
                console.error('Error loading font:', error);
            });
        });
        document.querySelector('.alert-button').addEventListener('click', () => {
            document.getElementById('alertBanner').classList.add('show');
            setTimeout(() => {
                document.getElementById('alertBanner').classList.remove('show');
            }, 3000);
        });
    </script>
</body>
</html>